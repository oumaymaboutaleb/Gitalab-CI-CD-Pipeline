stages:   
  - optimize
  - scanning  
  - test
  - build
  - deploy


optimize-dockerfile:
  stage: optimize
  image: node:14
  script:
    - sed -i 's/FROM node:/FROM node:alpine/' Dockerfile
    - wget -O hadolint "https://github.com/hadolint/hadolint/releases/download/v2.7.0/hadolint-Linux-x86_64"
    - chmod +x hadolint
    - mv hadolint /usr/local/bin/
    - wget -O dockerfilelint.tar.gz https://github.com/replicatedhq/dockerfilelint/releases/download/v0.2.11/dockerfilelint_0.2.11_linux_amd64.tar.gz
    - tar -xvzf dockerfilelint.tar.gz
    - mv dockerfilelint/dockerfilelint /usr/local/bin/
    - hadolint Dockerfile
    - dockerfile-lint Dockerfile
  
gitguardian scan:
  image: gitguardian/ggshield:latest
  stage: scanning
  script: ggshield secret scan ci
  
test-job:   
  stage: test 
  image: node:14
  before_script:
    - apt update
    - apt-get install mariadb-server -y
    - /etc/init.d/mysql start
    - mysql -u root -p -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';"
    - npm install -g sequelize-cli 
    - npm install
    - mysql -u root -proot -e "CREATE DATABASE student_test;"
    - sequelize db:migrate --env=test
    - npm install -g mocha 
    - npm install -g nyc 
  script:
    - nyc mocha --exit

